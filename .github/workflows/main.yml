name: Exabuster - Build Site

on:
  push

jobs:
  build:
    name: Build Site
    runs-on: ubuntu-latest
    steps:

      # Install the Exabuster Dependencies
      - name: Install Exabuster Dependencies
        run: |
          pip3 install setuptools
          pip3 install docopt==0.6.1 pyquery==1.2.8

      # Install the Ghost blogging platform
      - name: Install Ghost
        run: sudo npm install ghost-cli@latest -g

      # Go to a child folder
      - name: Make Working Directory
        run: mkdir TempGhostSite

      # Create a fresh ghost install
      - name: Make Executable Ghost Instance
        run: ghost install local
        working-directory: ./TempGhostSite

      # Run "ghost stop"
      - name: Stop Ghost Instance Execution (for now)
        run: ghost stop
        working-directory: ./TempGhostSite

      # Cache
      - uses: actions/cache@v2
        with:
          path: TempGhostSite
          key: TempGhostSite

      # Debug
      - name: Print Files in Current Directory
        run: ls

      # Debug
      - name: Print Files in Repo Directory
        run: ls
        working-directory: ./TempGhostSite

      # Checkout
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          lfs: true
          path: ./TempGhostRepo

      # Copy the contents of the repo into the fresh ghost install
      - name: Copy Repository Files to Working Directory
        run: |
          cp -vR ./TempGhostRepo/contents ./TempGhostSite
          cp -v ./TempGhostRepo/config.development.json ./TempGhostSite

      # Go into folder and run "ghost start"
      - name: Copy Repository Files to Working Directory
        run: ghost start
        working-directory: ./TempGhostSite

      # Go to parent folder and run Exabuster
      - name: Copy Repository Files to Working Directory
        run: python3 ./TempGhostRepo/exabuster.py generate --domain=localhost:2368 --new-domain=localhost:9000
        working-directory: ./TempGhostSite

      # Upload the results
      - name: Upload build artifacts
        uses: actions/upload-artifact@v2
        if: ${{ always() }}
        with:
          name: Static Ghost Blog
          path: static
